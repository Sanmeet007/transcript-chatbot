<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üé¨ Transcript Chatbot</title>
  <link rel="stylesheet" href="/static/style.css" />
  <style>
    .typing {
      font-style: italic;
      color: #aaa;
      margin: 8px 0;
      animation: blink 1.2s infinite;
    }

    @keyframes blink {
      0% { opacity: 0.2; }
      50% { opacity: 1; }
      100% { opacity: 0.2; }
    }
  </style>
</head>
<body>
  <div class="chat-wrapper">
    <div class="chat-container">
      <h1>üé¨ Transcript Chatbot</h1>

      <!-- Step 1: Load Video -->
      <div id="load-container" class="card">
        <div class="video-input">
          <input id="video-id" type="text" placeholder="Enter YouTube Video ID (e.g., 1qzrTvHGPow)" autocomplete="off"/>
          <button id="load-btn">Load Transcript</button>
        </div>
        <div id="loader" class="hidden"></div>
        <p id="load-status"></p>
      </div>

      <!-- Step 2: Chat Interface -->
      <div id="chat-section" class="hidden card">
        <div id="chat-box" class="chat-box"></div>

        <div class="input-container">
          <input id="query" type="text" placeholder="Type your question..." disabled />
          <button id="send" disabled>Send</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <script>
    async function startSession() {
      const res = await fetch("/session/start");
      const data = await res.json();
      console.log(data.message);
    }

    async function loadTranscript() {
      const videoId = document.getElementById("video-id").value.trim();
      const status = document.getElementById("load-status");
      const loader = document.getElementById("loader");

      if (!videoId) {
        status.textContent = "‚ö†Ô∏è Please enter a valid YouTube video ID.";
        return;
      }

      loader.classList.remove("hidden");
      status.textContent = "";

      const res = await fetch(`/load?video_id=${encodeURIComponent(videoId)}`, { method: "POST" });
      const data = await res.json();

      loader.classList.add("hidden");

      if (data.error) {
        status.textContent = `‚ùå ${data.error}`;
        return;
      }

      if (data.message) {
        status.textContent = `‚úÖ ${data.message}`;
        document.getElementById("chat-section").classList.remove("hidden");
        document.getElementById("query").disabled = false;
        document.getElementById("send").disabled = false;
      }
    }

    async function sendMessage() {
      const queryInput = document.getElementById("query");
      const query = queryInput.value.trim();
      if (!query) return;

      const chatBox = document.getElementById("chat-box");
      chatBox.innerHTML += `<div class='msg user-msg'>üßë‚Äçüíª ${query}</div>`;
      queryInput.value = "";

      // Add typing indicator
      const typingEl = document.createElement("div");
      typingEl.className = "msg bot-msg typing";
      typingEl.textContent = "ü§ñ typing...";
      chatBox.appendChild(typingEl);
      chatBox.scrollTop = chatBox.scrollHeight;

      try {
        const response = await fetch("/ask", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ query }),
        });

        const data = await response.json();
        chatBox.removeChild(typingEl); // remove "..." once response arrives

        if (data.error) {
          chatBox.innerHTML += `<div class='msg bot-msg error'>‚ùå ${data.error}</div>`;
        } else {
          const htmlResponse = marked.parse(data.response);
          chatBox.innerHTML += `<div class='msg bot-msg'>ü§ñ ${htmlResponse}</div>`;
        }
      } catch (err) {
        chatBox.removeChild(typingEl);
        chatBox.innerHTML += `<div class='msg bot-msg error'>‚ùå Something went wrong.</div>`;
      }

      chatBox.scrollTop = chatBox.scrollHeight;
    }

    document.getElementById("load-btn").addEventListener("click", loadTranscript);
    document.getElementById("send").addEventListener("click", sendMessage);
    document.getElementById("query").addEventListener("keypress", e => {
      if (e.key === "Enter") sendMessage();
    });

    startSession();
  </script>
</body>
</html>
